# 订单簿模块测试用例补充

## 边界场景测试用例

### TC-OB-004: 订单簿为空时的边界处理
**目的**: 验证订单簿为空时调用获取最优价返回null

**前置条件**:
- 订单簿无数据

**测试步骤**:
1. 调用 getBestBid("XAUUSD")
2. 调用 getBestAsk("XAUUSD")

**预期结果**:
- 返回 null
- 无异常抛出

---

### TC-OB-005: 相同价格多笔订单的时间顺序
**目的**: 验证同价格多笔订单按时间顺序正确累加

**前置条件**:
- 订单簿初始为空

**测试步骤**:
1. 发送 Buy XAUUSD @ 2000 × 10 (t1)
2. 发送 Buy XAUUSD @ 2000 × 20 (t2, t2 > t1)
3. 发送 Buy XAUUSD @ 2000 × 30 (t3, t3 > t2)
4. 查询订单簿

**预期结果**:
- 价格档位 [2000] 数量 = 60
- 价源记录包含所有3笔订单的时间戳

---

### TC-OB-006: 不同价源数据聚合
**目的**: 验证多价源同档位数据正确聚合

**前置条件**:
- 订单簿初始为空

**测试步骤**:
1. 发送 SOURCE_A Buy XAUUSD @ 2000 × 10
2. 发送 SOURCE_B Buy XAUUSD @ 2000 × 20
3. 发送 SOURCE_A Sell XAUUSD @ 2001 × 15
4. 查询订单簿

**预期结果**:
- Buy档位 [2000, 30], 来源: SOURCE_A, SOURCE_B
- Sell档位 [2001, 15], 来源: SOURCE_A
- 来源信息完整保留

---

### TC-OB-007: 订单删除/过期处理
**目的**: 验证订单过期后正确从订单簿移除

**前置条件**:
- 订单簿有数据

**测试步骤**:
1. 发送 Buy 订单，设置过期时间
2. 等待过期
3. 检查订单簿状态

**预期结果**:
- 过期订单从聚合中移除
- 数量正确扣减

---

### TC-OB-008: 高频更新压力测试
**目的**: 验证毫秒级高频更新的线程安全性

**测试步骤**:
1. 启动 100 线程并发更新
2. 每秒 1000 次更新
3. 持续 10 秒
4. 验证最终数据一致性

**预期结果**:
- 无数据丢失
- 无数据重复
- 最终聚合结果正确

---

### TC-OB-009: 快照生成与恢复
**目的**: 验证快照生成和恢复的完整性

**前置条件**:
- 订单簿有数据

**测试步骤**:
1. 构建订单簿数据
2. 执行 snapshot()
3. 清除内存数据
4. 从快照恢复
5. 对比恢复前后数据

**预期结果**:
- 快照数据完整
- 恢复后数据与快照一致

---

### TC-OB-010: 市场类型隔离
**目的**: 验证不同市场类型订单簿独立

**测试步骤**:
1. 发送 境内黄金 XAUUSD Buy @ 2000 × 10
2. 发送 境内外汇 XAUUSD Buy @ 2000 × 20
3. 分别查询两个订单簿

**预期结果**:
- 境内黄金订单簿: XAUUSD [2000 × 10]
- 境内外汇订单簿: XAUUSD [2000 × 20]
- 数据不混淆

---

## 性能测试用例

### PT-OB-001: 订单簿更新延迟测试
- 目标: < 100ms
- 方法: 测量从 updateQuote 到订单簿更新的时间
- 验证: P99 < 100ms

### PT-OB-002: 内存占用测试
- 目标: 单品种订单簿 < 10MB
- 方法: 持续更新后检查JVM内存
- 验证: 无内存泄漏

---

## 集成测试用例

### IT-OB-001: 价源适配器集成
**目的**: 验证价源数据正确流入订单簿

**测试步骤**:
1. 模拟价源适配器发送报价数据
2. 验证数据正确更新到订单簿

**预期结果**:
- 数据格式正确转换
- 价源标识正确设置

---

## 测试数据模板

### 示例订单簿数据
```json
{
  "symbol": "XAUUSD",
  "marketType": 1,
  "entries": [
    {
      "side": 1,
      "price": "2000.00",
      "quantity": "100.00",
      "source": "DIMPLE"
    }
  ]
}
```
