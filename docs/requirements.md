# 量化做市系统 - 需求规格文档

## 1. 项目概述

### 1.1 项目背景
开发一套量化做市系统，接入多渠道报价数据，构建本地深度订单簿，通过CFETS前置进行报价交易，并实现风控和审计功能。

### 1.2 系统目标
- 聚合多市场报价数据，构建实时订单簿
- 实现最优价格+点差做市报价
- 集成风控前置+事后检查
- 完整的审计日志支持

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          量化做市系统架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │  Dimple接入   │    │ CFETS MQ接入  │    │ 外资行 MQ接入 │              │
│  │   (JNI桥接)   │    │   (行内报文)   │    │  (行内报文)   │              │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘              │
│         │                  │                  │                        │
│         └──────────────────┼──────────────────┘                        │
│                            │                                            │
│                            ▼                                            │
│              ┌─────────────────────────────┐                           │
│              │     价源适配器层              │                           │
│              │  (统一数据格式 + 源标识)      │                           │
│              └─────────────┬───────────────┘                           │
│                            │                                            │
│         ┌──────────────────┼──────────────────┐                        │
│         ▼                  ▼                  ▼                        │
│  ┌────────────┐    ┌────────────┐    ┌────────────┐                   │
│  │ 境内黄金   │    │ 境内外汇   │    │  境外市场   │                   │
│  │ 订单簿     │    │ 订单簿     │    │  订单簿     │                   │
│  └─────┬──────┘    └─────┬──────┘    └─────┬──────┘                   │
│        │                 │                 │                          │
│        └─────────────────┼─────────────────┘                          │
│                          │                                              │
│                          ▼                                              │
│              ┌─────────────────────────────┐                           │
│              │      报价引擎核心            │                           │
│              │  • 最优价提取 + 点差计算     │                           │
│              │  • 报价生成                  │                           │
│              └─────────────┬───────────────┘                           │
│                            │                                            │
│                            ▼                                            │
│              ┌─────────────────────────────┐                           │
│              │       风控前置检查           │                           │
│              │  • 单笔限额检查              │                           │
│              │  • 仓位限制检查              │                           │
│              └─────────────┬───────────────┘                           │
│                            │                                            │
│              ┌─────────────┴─────────────┐                             │
│              ▼                           ▼                             │
│  ┌────────────────────┐    ┌────────────────────┐                      │
│  │   CFETS/Dimple前置  │    │     审计模块        │                      │
│  │   (外部系统接口)    │    │     (MySQL)        │                      │
│  └─────────┬──────────┘    └─────────┬──────────┘                      │
│            │                         │                                  │
│            │    ┌────────────────────┘                                  │
│            │    │                                                      │
│            ▼    ▼                                                      │
│  ┌─────────────────────────────┐                                      │
│  │       成交回报处理           │                                      │
│  │  • 关联订单ID                │                                      │
│  │  • 更新持仓                  │                                      │
│  │  • 风控事后检查              │                                      │
│  │  • 审计记录                  │                                      │
│  └─────────────┬───────────────┘                                      │
│                │                                                      │
│                ▼                                                      │
│  ┌─────────────────────────────┐                                      │
│  │       持仓管理 + 风控复核    │                                      │
│  └─────────────────────────────┘                                      │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 功能需求

### 3.1 数据接入模块

#### 3.1.1 Dimple接入（境内黄金）
- **接入方式**：JNI桥接Dimple SO库
- **数据格式**：Event事件推送
- **数据内容**：黄金品种报价
- **更新频率**：实时毫秒级

#### 3.1.2 CFETS MQ接入（境内外汇）
- **接入方式**：订阅消息队列
- **数据格式**：行内报文格式
- **数据内容**：外汇报价数据
- **价源**：CFETS外汇报价

#### 3.1.3 外资行MQ接入（境外市场）
- **接入方式**：订阅消息队列
- **数据格式**：行内报文格式
- **数据内容**：境外外汇 + 境外黄金报价
- **价源**：外资行报价

#### 3.1.4 统一价源适配
- 统一数据格式转换
- 价源标识管理
- 时间戳标准化

---

### 3.2 订单簿模块

#### 3.2.1 订单簿设计
- **分离设计**：境内/境外订单簿独立
- **聚合方式**：按价格档位聚合
- **刷新频率**：毫秒级
- **数据保留**：仅保留最新快照

#### 3.2.2 订单簿数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | VARCHAR(32) | 品种代码 |
| market_type | TINYINT | 市场类型(1=境内黄金,2=境内外汇,3=境外) |
| source | VARCHAR(32) | 价源标识 |
| side | TINYINT | BUY=1/SELL=2 |
| price_level | INT | 价格档位序号 |
| price | DECIMAL(18,8) | 分档价格 |
| quantity | DECIMAL(18,8) | 数量 |
| snapshot_time | DATETIME(3) | 快照时间 |

#### 3.2.3 订单簿初始化
- 启动时从价源拉取初始订单簿
- 支持全量数据初始化

---

### 3.3 报价引擎模块

#### 3.3.1 报价策略
- **报价依据**：境内订单簿
- **报价方式**：最优价格 + 固定点差
- **点差配置**：由业务设置，固定值

#### 3.3.2 报价流程
1. 从境内订单簿提取最优价格
2. 根据买卖方向加减点差
3. 生成报价请求
4. 风控前置检查
5. 提交到CFETS/Dimple前置

#### 3.3.3 报价生命周期
- CREATED → PENDING → SUBMIT → PARTIAL/FULL_FILLED → COMPLETED
- 支持部分成交
- 支持撤单
- 支持过期处理

---

### 3.4 风控模块

#### 3.4.1 风控规则
- **单笔限额**：区分买卖方向，参数存库配置
- **仓位限制**：总体持仓限制
- **检查时机**：前置检查 + 事后检查

#### 3.4.2 风控参数配置
- 存储位置：数据库（risk_config表）
- 支持在线更新
- 支持按产品/全局配置

#### 3.4.3 风控流程
```
报价请求 → 前置风控检查 → 通过? → 提交交易 → 成交回报 → 事后风控检查
                    ↓ 否
                拦截并记录审计
```

---

### 3.5 审计模块

#### 3.5.1 审计事件类型
- QUOTE_GENERATED - 报价生成
- QUOTE_SUBMITTED - 报价提交
- QUOTE_REJECTED - 风控拦截
- TRADE_RECEIVED - 成交回报
- TRADE_CONFIRMED - 事后风控通过
- TRADE_REJECTED - 事后风控拦截
- PARAM_CHANGED - 参数变更
- ORDER_BOOK_SNAPSHOT - 订单簿快照

#### 3.5.2 审计数据
- 事件类型、时间
- 关联订单ID
- 详细信息（JSON）
- 风控检查结果
- 订单簿快照
- 操作人/IP

#### 3.5.3 审计存储
- 存储介质：MySQL
- 支持查询接口
- 预留管理台对接

---

### 3.6 成交回报模块

#### 3.6.1 回报接收
- **Dimple**：Event事件推送
- **CFETS**：前置系统返回

#### 3.6.2 回报处理
- 关联订单ID
- 更新成交数量
- 更新持仓
- 事后风控检查
- 审计记录

#### 3.6.3 部分成交支持
- 支持单笔报价分多次成交
- 实时更新订单状态

---

### 3.7 持仓管理模块

#### 3.7.1 持仓数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | VARCHAR(32) | 品种代码 |
| market_type | TINYINT | 市场类型 |
| side | VARCHAR(8) | 持仓方向(LONG/SHORT) |
| quantity | DECIMAL(18,8) | 持仓数量 |
| avg_price | DECIMAL(18,8) | 平均成本价 |

#### 3.7.2 持仓更新
- 成交回报到达时更新
- 支持境内/境外分别平仓

---

## 4. 非功能需求

### 4.1 性能需求
- 订单簿更新：毫秒级
- 风控检查：微秒级
- 报价延迟：可控范围

### 4.2 可用性
- K8s部署
- 支持配置热更新

### 4.3 数据持久化
- MySQL存储
- 订单簿快照
- 成交记录
- 审计日志

---

## 5. 外部接口

### 5.1 输入接口
- Dimple Event API
- MQ消息订阅
- CFETS前置接口

### 5.2 输出接口
- 报价提交接口
- 审计查询接口
- 风控参数配置接口

---

## 6. 安全需求

### 6.1 数据安全
- 敏感日志脱敏
- 操作审计追溯

### 6.2 接口安全
- 内部系统对接
- 权限控制预留

---

## 7. 约束条件

### 7.1 技术约束
- Java技术栈
- MySQL数据库
- K8s部署环境

### 7.2 业务约束
- 只做境内市场做市
- 境外盘仅用于平仓

---

## 8. 验收标准

### 8.1 功能验收
- [ ] 多价源数据接入正常
- [ ] 订单簿聚合正确
- [ ] 报价生成准确
- [ ] 风控拦截生效
- [ ] 审计记录完整
- [ ] 成交回报处理正确

### 8.2 性能验收
- [ ] 订单簿延迟 < 100ms
- [ ] 风控检查 < 10ms
- [ ] 系统稳定运行

---

## 9. 项目里程碑

### Phase 1: 基础架构
- 项目搭建
- 数据库设计
- 核心框架

### Phase 2: 数据接入
- Dimple接入
- MQ消息接入
- 订单簿构建

### Phase 3: 报价引擎
- 最优价提取
- 点差计算
- 报价提交

### Phase 4: 风控审计
- 风控前置
- 风控事后
- 审计模块

### Phase 5: 测试验收
- 单元测试
- 集成测试
- UAT验收

---

## 10. 附录

### 10.1 数据字典
详见数据库设计文档

### 10.2 接口定义
详见API接口文档

### 10.3 状态机定义
详见订单状态流转文档
