# 量化做市系统 - 测试计划文档

## 1. 文档概述

本文档描述量化做市系统的测试计划，包括测试范围、测试策略、测试用例和验收标准。

---

## 2. 测试范围

### 2.1 测试模块
| 模块 | 测试内容 |
|------|----------|
| 数据接入层 | Dimple适配器、MQ适配器、价源统一转换 |
| 订单簿模块 | 数据聚合、快照生成、初始化 |
| 报价引擎 | 最优价提取、点差计算、报价生成 |
| 风控模块 | 前置检查、事后检查、参数配置 |
| 成交回报 | 订单关联、持仓更新、部分成交 |
| 审计模块 | 事件记录、快照存储、查询接口 |
| 持仓管理 | 持仓计算、方向管理 |

### 2.2 测试类型
- **单元测试**：核心算法和业务逻辑
- **集成测试**：模块间交互
- **系统测试**：端到端业务流程
- **性能测试**：延迟和吞吐量

---

## 3. 测试环境

### 3.1 硬件环境
- 开发环境：本地Docker
- 测试环境：K8s测试集群
- 数据库：MySQL 8.0

### 3.2 软件环境
- JDK 17+
- Spring Boot 3.x
- RabbitMQ/Kafka（根据实际MQ类型）

### 3.3 测试数据
- 模拟Dimple报价Event
- 模拟MQ报价消息
- 静态CFETS前置返回

---

## 4. 测试用例

### 4.1 数据接入层测试

#### TC-DI-001: Dimple报价事件解析
**目的**：验证Dimple Event正确转换为统一格式

**前置条件**：
- Dimple SO库模拟器运行
- 测试Event数据准备

**测试步骤**：
1. 发送模拟Dimple Event
2. 解析并转换为统一格式
3. 验证字段映射正确性

**预期结果**：
- Symbol转换正确
- Side(BUY/SELL)映射正确
- Price/Quantity精度正确
- Timestamp格式正确

**优先级**：P0

---

#### TC-DI-002: MQ消息解析
**目的**：验证MQ报价消息正确解析

**前置条件**：
- MQ测试客户端连接
- 标准报文格式消息

**测试步骤**：
1. 订阅测试Topic
2. 接收并解析消息
3. 验证字段完整性

**预期结果**：
- 报文格式正确解析
- 价源标识正确提取
- 时间戳标准化

**优先级**：P0

---

#### TC-DI-003: 多价源数据聚合
**目的**：验证多价源数据合并到订单簿

**前置条件**：
- 两个以上价源数据
- 相同品种不同价源

**测试步骤**：
1. 发送不同价源报价
2. 触发订单簿聚合
3. 验证聚合结果

**预期结果**：
- 相同档位数量累加
- 不同档位独立存在
- 价源标识记录完整

**优先级**：P1

---

### 4.2 订单簿模块测试

#### TC-OB-001: 订单簿档位聚合
**目的**：验证按价格档位正确聚合

**前置条件**：
- 订单簿初始化
- 多笔同档位报价

**测试步骤**：
1. 发送3笔Buy报价，价格100，数量分别为10、20、30
2. 发送2笔Sell报价，价格101，数量分别为15、25
3. 查询订单簿状态

**预期结果**：
- Buy档位[100, 60]
- Sell档位[101, 40]
- 档位顺序正确

**优先级**：P0

---

#### TC-OB-001-Enhanced: 深度报价聚合
**目的**：验证真实场景下的深度报价（Depth of Market）正确聚合

**前置条件**：
- 订单簿初始化
- 接收完整的深度报价数据

**测试数据**：
每个深度报价档位包含以下6个字段：
| 字段 | 说明 | 示例值 |
|------|------|--------|
| priceLevel | 价格档位序号 | 1, 2, 3... |
| source | 价源标识 | DIMPLE, CFETS, FOREIGN_BANK |
| marketType | 市场类型 | 1=境内黄金, 2=境内外汇, 3=境外 |
| side | 买卖方向 | 1=BUY, 2=SELL |
| price | 档位价格 | 2000.00, 380.50 |
| quantity | 档位数量 | 100.00, 500000 |

**测试步骤**：
1. 发送Dimple境内黄金深度报价（5档Bid + 5档Ask）
2. 发送CFETS境内外汇深度报价
3. 发送外资行境外外汇深度报价
4. 查询各订单簿状态

**预期结果**：
- 境内黄金(XAUUSD):
  - Best Bid: 2000.00 × 100.00
  - Best Ask: 2000.50 × 80.00
  - Spread: 0.50
- 境内外汇(USDJPY):
  - Best Bid: 7.2500 × 1M
  - Best Ask: 7.2550 × 0.8M
- 境外外汇(EURUSD):
  - Best Bid: 1.0800 × 0.5M
  - Best Ask: 1.0850 × 0.4M
- 各市场类型订单簿独立
- 多价源数据正确聚合

**优先级**：P0

**测试文件**：
- `OrderBookDepthTest.java`


---

#### TC-OB-002: 订单簿快照生成
**目的**：验证订单簿快照正确生成和存储

**前置条件**：
- 订单簿有数据
- 快照配置启用

**测试步骤**：
1. 触发快照生成（定时/手动）
2. 查询快照表数据

**预期结果**：
- 快照时间正确
- 所有档位数据完整
- 关联订单簿ID正确

**优先级**：P1

---

#### TC-OB-003: 订单簿初始化
**目的**：验证启动时正确初始化订单簿

**前置条件**：
- 数据库有历史快照
- 系统重启

**测试步骤**：
1. 停止系统
2. 清除内存数据
3. 重启系统
4. 检查订单簿状态

**预期结果**：
- 从快照恢复数据
- 数据完整性校验通过
- 实时更新正常

**优先级**：P1

---

### 4.3 报价引擎测试

#### TC-QE-001: 最优价提取
**目的**：验证正确提取最优报价

**前置条件**：
- 订单簿有多个档位

**测试步骤**：
1. 构建订单簿数据
   - Buy: [100×50, 99×30, 98×20]
   - Sell: [101×40, 102×60]
2. 请求最优Buy价
3. 请求最优Sell价

**预期结果**：
- 最优Buy价 = 100
- 最优Sell价 = 101
- 档位信息正确

**优先级**：P0

---

#### TC-QE-002: 点差计算
**目的**：验证点差正确应用

**前置条件**：
- 最优价已提取
- 点差配置已设置

**测试步骤**：
1. 最优Buy价 = 100
2. 最优Sell价 = 101
3. 设置点差 = 0.5
4. 生成报价

**预期结果**：
- Buy报价 = 99.5 (100 - 0.5)
- Sell报价 = 101.5 (101 + 0.5)

**优先级**：P0

---

#### TC-QE-003: 报价生成流程
**目的**：验证完整报价生成流程

**前置条件**：
- 订单簿数据正常
- 风控前置通过

**测试步骤**：
1. 请求Buy报价，Quantity=100
2. 检查风控前置
3. 生成报价请求
4. 创建订单记录

**预期结果**：
- 订单状态 = CREATED
- OrderID生成唯一
- 报价价格计算正确

**优先级**：P0

---

#### TC-QE-004: 报价提交
**目的**：验证报价正确提交到前置

**前置条件**：
- 报价已生成
- 前置模拟器就绪

**测试步骤**：
1. 提交报价到CFETS前置
2. 接收提交响应

**预期结果**：
- 提交成功
- 订单状态 = SUBMIT
- 提交时间记录正确

**优先级**：P0

---

### 4.4 风控模块测试

#### TC-RK-001: 前置风控-单笔限额
**目的**：验证单笔限额检查

**前置条件**：
- 风控参数配置
- 单笔限额 = 50

**测试步骤**：
1. 尝试报价Buy 100手
2. 检查风控结果

**预期结果**：
- 风控拦截
- 错误提示：超过单笔限额
- 订单状态 = PRE_REJECTED
- 审计记录

**优先级**：P0

---

#### TC-RK-002: 前置风控-仓位限制
**目的**：验证仓位限制检查

**前置条件**：
- 当前持仓 = 80
- 仓位限制 = 100

**测试步骤**：
1. 尝试Buy 30手
2. 检查风控结果

**预期结果**：
- 风控通过
- 预计仓位 = 110 > 100
- 实际成交前不拦截
- 事后检查拦截

**优先级**：P0

---

#### TC-RK-003: 事后风控检查
**目的**：验证成交后风控复核

**前置条件**：
- 成交回报到达
- 仓位超限

**测试步骤**：
1. 接收成交回报，成交量使持仓超限
2. 执行事后风控检查

**预期结果**：
- 风控拦截
- 告警通知
- 审计记录TRADE_REJECTED

**优先级**：P0

---

#### TC-RK-004: 风控参数热更新
**目的**：验证参数在线更新

**前置条件**：
- 系统运行中
- 原限额 = 50

**测试步骤**：
1. 更新限额为100
2. 验证新参数生效
3. 尝试原限额超量报价

**预期结果**：
- 参数更新成功
- 新限额立即生效
- 审计记录PARAM_CHANGED

**优先级**：P1

---

### 4.5 成交回报测试

#### TC-TR-001: 成交回报关联
**目的**：验证成交回报正确关联订单

**前置条件**：
- 订单已提交
- OrderID已生成

**测试步骤**：
1. 接收成交回报（包含OrderID）
2. 更新订单状态
3. 更新成交数量

**预期结果**：
- 订单找到
- 关联正确
- 成交数量累加

**优先级**：P0

---

#### TC-TR-002: 部分成交处理
**目的**：验证部分成交正确处理

**前置条件**：
- 订单数量 = 100
- 已成交 = 30

**测试步骤**：
1. 接收成交回报 +40
2. 更新订单状态
3. 验证状态流转

**预期结果**：
- 已成交 = 70
- 状态 = PARTIAL
- 继续等待成交

**优先级**：P0

---

#### TC-TR-003: 全部成交
**目的**：验证全部成交处理

**前置条件**：
- 订单状态 = PARTIAL
- 剩余数量 = 20

**测试步骤**：
1. 接收成交回报 +20
2. 更新订单状态
3. 更新持仓

**预期结果**：
- 已成交 = 数量
- 状态 = COMPLETED
- 持仓更新

**优先级**：P0

---

### 4.6 审计模块测试

#### TC-AD-001: 审计事件记录
**目的**：验证所有事件正确记录

**前置条件**：
- 审计模块正常运行

**测试步骤**：
1. 执行报价生成
2. 执行报价提交
3. 执行成交回报
4. 查询审计日志

**预期结果**：
- QUOTE_GENERATED记录
- QUOTE_SUBMITTED记录
- TRADE_RECEIVED记录
- 字段完整性

**优先级**：P0

---

#### TC-AD-002: 订单簿快照记录
**目的**：验证订单簿快照正确存入审计

**前置条件**：
- 审计快照配置启用

**测试步骤**：
1. 触发快照
2. 查询审计记录
3. 验证快照JSON

**预期结果**：
- ORDER_BOOK_SNAPSHOT事件
- 快照数据完整
- 可以追溯查询

**优先级**：P1

---

#### TC-AD-003: 审计查询接口
**目的**：验证审计日志查询功能

**前置条件**：
- 审计数据已生成

**测试步骤**：
1. 按时间范围查询
2. 按订单ID查询
3. 按事件类型查询

**预期结果**：
- 返回正确结果
- 分页正常
- 排序正确

**优先级**：P1

---

### 4.7 持仓管理测试

#### TC-PO-001: 持仓计算
**目的**：验证持仓正确计算

**前置条件**：
- 空持仓

**测试步骤**：
1. Buy成交 100手 @ 100
2. 查询持仓

**预期结果**：
- LONG 100手
- 平均成本 = 100

**优先级**：P0

---

#### TC-PO-002: 持仓更新
**目的**：验证持仓随成交更新

**前置条件**：
- 已有持仓

**测试步骤**：
1. 已有LONG 100手
2. Sell成交 30手 @ 105
3. 查询持仓

**预期结果**：
- LONG 70手
- 平均成本重新计算

**优先级**：P0

---

## 5. 性能测试

### 5.1 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 订单簿更新延迟 | < 100ms | 从价源数据到订单簿 |
| 风控检查延迟 | < 10ms | 前置风控检查 |
| 报价生成延迟 | < 50ms | 从请求到报价生成 |
| 系统吞吐量 | > 1000 TPS | 报价处理能力 |

### 5.2 性能测试用例

#### PT-001: 高频报价压力测试
- 目的：测试系统在高负载下的表现
- 方式：并发100线程，持续5分钟
- 监控：延迟分布、错误率

#### PT-002: 订单簿更新压力测试
- 目的：测试订单簿在高频率更新下的稳定性
- 方式：每秒1000次更新
- 验证：数据一致性

---

## 6. 集成测试

### 6.1 端到端测试

#### E2E-001: 完整报价流程
1. 价源数据 → 订单簿聚合
2. 报价请求 → 风控前置
3. 报价提交 → CFETS前置
4. 成交回报 → 持仓更新
5. 事后风控 → 审计记录

#### E2E-002: 完整做市流程
1. 实时订单簿更新
2. 周期性报价生成
3. 自动化风控检查
4. 成交回报处理
5. 审计日志记录

---

## 7. 测试执行计划

### 7.1 测试阶段
| 阶段 | 内容 | 产出 |
|------|------|------|
| UT | 单元测试 | 测试报告 |
| IT | 集成测试 | 测试报告 |
| ST | 系统测试 | 测试报告 |
| PT | 性能测试 | 性能报告 |
| UAT | 用户验收 | 验收报告 |

### 7.2 测试通过标准
- 所有P0用例通过率 = 100%
- 所有P1用例通过率 >= 95%
- 性能指标达标
- 无严重缺陷

---

## 8. 缺陷管理

### 8.1 缺陷等级
- **P0**: 阻塞主流程，必须立即修复
- **P1**: 影响核心功能，24小时内修复
- **P2**: 一般问题，下一版本修复
- **P3**: 建议改进

### 8.2 缺陷跟踪
- 使用GitHub Issues跟踪
- 定期评审缺陷
- 及时沟通解决

---

## 9. 附录

### 9.1 测试数据模板
详见 /tests/data/

### 9.2 测试脚本
详见 /tests/scripts/

### 9.3 测试工具
- JUnit 5
- Mockito
- Postman/Newman
- JMeter
